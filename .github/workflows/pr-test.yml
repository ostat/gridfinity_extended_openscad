name: PR OpenSCAD Test

# Trigger workflow on any pull request
on:
  pull_request:
    paths:
      - "**/*.scad"        # Only run if OpenSCAD files change
      - "scripts/**"       # Or your scripts change

jobs:
  test:
    runs-on: windows-latest   # Use Windows runner for PowerShell

    steps:
      # Step 1: Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Download OpenSCAD portable zip (nightly or stable)
      - name: Download OpenSCAD
        shell: pwsh
        run: |
          $scadversion = 'OpenSCAD-2026.02.13-x86-64'
          $zipUrl = "https://files.openscad.org/snapshots/$($scadversion).zip"
          $zipPath = "$env:RUNNER_TEMP\openscad.zip"
          write-host "Downloading souce:'$($zipUrl)' to destination: '$($zipPath)'"
          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath

          $extractPath = "$env:RUNNER_TEMP\openscad"
          write-host "Extracting souce:'$($zipPath)' to destination: '$($extractPath)'"
          Expand-Archive -LiteralPath $zipPath -OutputPath $extractPath -Force

          # Save path to exe as environment variable for later steps
          $exePath = Join-Path $extractPath "$($scadversion)\OpenSCAD.exe"
          write-host "Setting env path:'$($exePath )'"
          Write-Host "OPENSCAD_PATH=$exePath" >> $env:GITHUB_ENV

      # Step 3: Verify OpenSCAD is available
      - name: Verify OpenSCAD
        shell: pwsh
        run: |
          & "$env:OPENSCAD_PATH" --version

      # Step 4: Run your PowerShell test script
      - name: Run OpenSCAD tests
        shell: pwsh
        run: pwsh ./scripts/test-render.ps1  -OpenScadPath $env:OPENSCAD_PATH